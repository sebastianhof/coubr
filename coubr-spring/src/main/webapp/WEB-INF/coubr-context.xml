<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/mvc
                           http://www.springframework.org/schema/mvc/spring-mvc.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/security
                           http://www.springframework.org/schema/security/spring-security.xsd">

    <!-- **************************************************************** -->
    <!--  CONTEXT CONFIGURATION                                           -->
    <!-- **************************************************************** -->
    <context:component-scan base-package="com.coubr.main"/>
    <context:component-scan base-package="com.coubr.main.controller"/>

    <context:component-scan base-package="com.coubr.business"/>
    <context:component-scan base-package="com.coubr.business.services"/>

    <context:component-scan base-package="com.coubr.app"/>
    <context:component-scan base-package="com.coubr.app.services"/>

    <context:component-scan base-package="com.coubr.data"/>
    <context:component-scan base-package="com.coubr.data.repositories"/>

    <!-- **************************************************************** -->
    <!--  SECURITY CONFIGURATION                                          -->
    <!-- **************************************************************** -->

    <security:http auto-config="true" use-expressions="true" authentication-manager-ref="authenticationManager">
        <security:intercept-url pattern="/app/**" access="permitAll" requires-channel="https"/>
        <security:intercept-url pattern="/a/**" access="permitAll" requires-channel="https"/>
        <security:intercept-url pattern="/business/**" access="permitAll" requires-channel="https"/>
        <security:intercept-url pattern="/b/**" access="hasRole('ROLE_BUSINESS_OWNER')" requires-channel="https"/>

        <security:form-login login-page="/business#/login"
                             default-target-url="/b"/>

        <security:logout logout-success-url="/business" logout-url="/b/logout.do"/>

        <security:port-mappings>
            <!-- Default ports -->
            <security:port-mapping http="80" https="443"/>
            <!-- Tomcat default ports -->
            <security:port-mapping http="8080" https="8443"/>
        </security:port-mappings>
        <security:logout invalidate-session="true"/>
        <security:session-management session-fixation-protection="newSession"/>

    </security:http>

    <security:authentication-manager alias="authenticationManager">

        <security:authentication-provider user-service-ref="authenticationService">

            <security:password-encoder ref="bcryptEncoder"/>

        </security:authentication-provider>

    </security:authentication-manager>

    <!-- **************************************************************** -->
    <!--  RESOURCE FOLDERS CONFIGURATION                                  -->
    <!-- **************************************************************** -->
    <mvc:annotation-driven/>

    <mvc:resources location="/WEB-INF/static/" mapping="/static/**"/>

    <!-- **************************************************************** -->
    <!--  BEANS CONFIGURATION                                             -->
    <!-- **************************************************************** -->

    <beans profile="local,cloud">

        <!-- **************************************************************** -->
        <!--  Logging                                                         -->
        <!-- **************************************************************** -->

        <bean class="ch.qos.logback.ext.spring.ApplicationContextHolder"/>

        <bean id="consoleAppender" class="ch.qos.logback.core.ConsoleAppender" init-method="start"
              destroy-method="stop">
            <property name="context" value="#{ T(org.slf4j.LoggerFactory).getILoggerFactory() }"/>
            <property name="encoder">
                <bean class="ch.qos.logback.classic.encoder.PatternLayoutEncoder" init-method="start"
                      destroy-method="stop">
                    <property name="context" value="#{ T(org.slf4j.LoggerFactory).getILoggerFactory() }"/>
                    <property name="pattern" value="%date %-5level [%thread] %logger{36} %m%n"/>
                </bean>
            </property>
        </bean>

    </beans>

    <beans profile="cloud">


    </beans>


</beans>